<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Live win rate</title>
    <link id="favicon" rel="icon" type="image/x-icon"/>
</head>
<body>
<script type="module">

    // -----------------------------------------------------------------
    // CONSTANTS
    // -----------------------------------------------------------------

    const SERVER_ADDRESS = 'ws://localhost:61942';

    const RANDOM_BATTLE = 1;
    const GRAND_BATTLE = 24;

    const WIN_RATE_BRACKETS = [
        bracket(0, 0.45, rgb(0, 0, 0)),
        bracket(0.45, 0.47, rgb(205, 51, 51)),
        bracket(0.47, 0.49, rgb(215, 121, 0)),
        bracket(0.49, 0.52, rgb(215, 182, 0)),
        bracket(0.52, 0.54, rgb(109, 149, 33)),
        bracket(0.54, 0.56, rgb(76, 118, 46)),
        bracket(0.56, 0.60, rgb(74, 146, 183)),
        bracket(0.60, 0.65, rgb(131, 87, 157)),
        bracket(0.65, null, rgb(90, 49, 117)),
    ];

    function rgb(red, green, blue) {
        return { red: red, green: green, blue: blue };
    }

    function bracket(from, to, color) {
        return { from: from, to: to, color: color };
    }

    function lookupWinRateColor(winRate) {
        const predicate = bracket => bracket.from <= winRate && (!bracket.to || winRate < bracket.to);
        const bracket = WIN_RATE_BRACKETS.find(predicate);
        return bracket ? bracket.color : rgb(0, 0, 0);
    }


    // -----------------------------------------------------------------
    // INIT
    // -----------------------------------------------------------------

    let victoryCount = 0;
    let lossCount = 0;
    let showDisconnectedHint = false;

    render();

    const ws = new WebSocket(SERVER_ADDRESS);
    ws.addEventListener('open', onOpen);
    ws.addEventListener('message', onMessage);
    ws.addEventListener('close', onDisconnect);
    ws.addEventListener('error', onDisconnect);


    // -----------------------------------------------------------------
    // EVENT HANDLERS
    // -----------------------------------------------------------------

    function onOpen() {
        const data = JSON.stringify([
            {
                messageType: 'REPLAY',
                payload: {}
            },
            {
                messageType: 'SUBSCRIBE',
                payload: {},
            },
        ]);
        ws.send(data);
    }

    function onMessage(event) {
        const message = JSON.parse(event.data);
        if (message.messageType === 'BATTLE_RESULT') {
            const result = message.payload.result;
            onResult(result);
        } else if (message.messageType === 'ERROR') {
            console.error('Protocol Error:', message.payload);
        }
    }

    function onResult(result) {
        if (!isRandomBattle(result)) {
            return
        }

        if (isVictory(result)) {
            victoryCount++;
        } else {
            lossCount++;
        }

        render();
    }

    function onDisconnect() {
        showDisconnectedHint = true;
        render();
    }


    // -----------------------------------------------------------------
    // BATTLE RESULT PARSING
    // -----------------------------------------------------------------

    function isRandomBattle(result) {
        const battleType = getBattleType(result);
        return battleType === RANDOM_BATTLE || battleType === GRAND_BATTLE;
    }

    function getBattleType() {
        return result && result.common && result.common.bonusType;
    }

    function isVictory(result) {
        return getTeam(result) === getWinnerTeam(result);
    }

    function getWinnerTeam(result) {
        return result && result.common && result.common.winnerTeam;
    }

    function getTeam(result) {
        return result && result.personal && result.personal.avatar && result.personal.avatar.team;
    }


    // -----------------------------------------------------------------
    // RENDERING
    // -----------------------------------------------------------------

    function render() {
        const winRate = victoryCount / (lossCount + victoryCount);
        document.title = renderTitle(winRate);
        document.body.innerHTML = renderContent(winRate, showDisconnectedHint);
        document.querySelector('#favicon').href = renderFavicon(winRate);
    }

    function renderTitle(winRate) {
        return `Win rate: ${renderWinRate(winRate)}`;
    }

    function renderContent(winRate, showDisconnectedHint) {
        const winRateColor = lookupWinRateColor(winRate)
        return `
            <style>
                body {
                    color: ${useWhiteText(winRateColor) ? 'white' : 'black'};
                    background-color: ${renderColor(winRateColor)};
                }

                .label {
                    font-size: 2.5rem;
                }

                .win-rate {
                    font-size: 8rem;
                }

                .container {
                    box-sizing: border-box;
                    padding: 1rem;
                    width: 100%;
                    text-align: center;
                    position: fixed;
                    top: 50%;
                    left: 0;
                    transform: translateY(-50%);
                    font-family: Arial, Helvetica, sans-serif;
                }
            </style>
            <div class="container">
                <div class="label">Win rate</div>
                <div class="win-rate">${renderWinRate(winRate)}</div>
                <div style="display: ${showDisconnectedHint ? 'block' : 'none'}">
                    Disconnected.<br>
                    Could not connect to battle results server.<br>
                    Make sure that WoT is running and that the battle results server mod is installed correctly.<br>
                    Refresh this page to reconnect.
                </div>
            </div>
        `;
    }

    function renderFavicon(winRate) {
        const winRateColor = lookupWinRateColor(winRate);

        const canvas = document.createElement('canvas');
        canvas.height = 16;
        canvas.width = 16;

        const ctx = canvas.getContext("2d");
        ctx.fillStyle = renderColor(winRateColor);
        ctx.beginPath();
        ctx.rect(0, 0, 16, 16);
        ctx.fill();

        return canvas.toDataURL();
    }

    function renderWinRate(winRate) {
        return isNaN(winRate) ? 'N/A' : `${(winRate * 100).toFixed(0)}%`;
    }

    function renderColor(color) {
        return `rgb(${color.red}, ${color.green}, ${color.blue})`;
    }

    function useWhiteText(color) {
        const brightness = (color.red * 299 + color.green * 587 + color.blue * 114) / 1000;
        return brightness < 125;
    }
</script>
</body>
</html>